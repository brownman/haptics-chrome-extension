<!DOCTYPE html> 
<html>
<link rel="stylesheet" type="text/css" href="/css/popup.css">
<script>
// The background page is needed since it hosts the plugin.
var bkg = chrome.extension.getBackgroundPage();

// Alias the plugin to haptics.
var haptics = bkg.plugin;

// There is something very weird.
// When I set the number below decimal point as 0, there is no force on the device.
// For example, it works with 10.1, 14.7, etc. except 10.0, 13.0.
var force = new Array(0.1, 0.1, 10.1);

// Haptics timing interval, that manages the timings.
var interval;

/**
 * Starts the haptics device.
 */
function startDevice() {
  bkg.console.debug('Starting');
  haptics.startDevice();
}

/**
 * Stops the haptics device.
 */
function stopDevice() {
  bkg.console.debug('Stoping');
  haptics.stopDevice();
}

/**
 * The haptic loop running at 1ms intervals. Try not to do many computations here
 * or the loop will slow down.
 */
function hapticLoop() {
  virtualSphereRunner();
}

/**
 * Virtual Wall example.
 */
function virtualWallRunner() {
  var position = haptics.position;
  var stiffness = 1000.0;
  var wall_position_z = 0.0;
  if (position[2] < wall_position_z)
    force[2] = stiffness * (wall_position_z - position[2]);
  else
    force[2] = 0.0;
  haptics.sendForce(force);
}

/**
 * Virtual Sphere example.
 */
function virtualSphereRunner() {
  var position = haptics.position;
  var stiffness = 1000.0;
  // Virtual Sphere
  var radius = 0.03;
  var distance = Math.sqrt(position[0]*position[0] + position[1]*position[1] +
      position[2]*position[2]);

  var vector = new Array;
  vector[0] = position[0]/distance;
  vector[1] = position[1]/distance;
  vector[2] = position[2]/distance;

  if( distance < radius ) {
    force[0] = stiffness*(radius - distance)* vector[0];
    force[1] = stiffness*(radius - distance)* vector[1];
    force[2] = stiffness*(radius - distance)* vector[2];
  } else {
    force[0] = 0.0;
    force[1] = 0.0;
    force[2] = 0.0;
  }
  haptics.sendForce(force);
}

/**
 * Runs the haptic loop at 1ms intervals.
 */
function runProgram() {
  interval = setInterval("hapticLoop()", 1);
  bkg.console.debug('Run Program');
}

/**
 * Clears the interval gracefull so it stops running.
 */
function stopProgram() {
  clearInterval(interval);

  // Set the force to zero and then quit the program
  force[0] = 0.0;
  force[1] = 0.0;
  force[2] = 0.0;
  haptics.sendForce(force);

  bkg.console.debug('Quit Program');
}

</script>
<body> 
  <h2>Haptics Controller</h2>
  <fieldset id="process-group">
    <legend>Process</legend>
    <button onclick="runProgram()">Run</button>
    <button onclick="stopProgram()">Stop</button>
  </fieldset>
  <fieldset id="device-group">
    <legend>Device</legend>
    <button onclick="startDevice()">Start</button>
    <button onclick="stopDevice()">Stop</button>
  </fieldset>
</body>
</html>